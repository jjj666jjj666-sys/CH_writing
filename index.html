<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>한자 쓰기 애니메이션 & 획별 스냅샷</title>
  <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@latest/dist/hanzi-writer.min.js"></script>
  <style>
    body{font-family:sans-serif; margin:28px}
    h1{margin-bottom:12px}
    .row{display:flex; gap:24px; align-items:flex-start}
    #stage{
      width:240px;height:240px;border:1px solid #bbb;border-radius:8px;
      display:flex;align-items:center;justify-content:center;overflow:hidden;
      background:#fff;
    }
    #controls{display:flex;gap:8px;margin:12px 0 20px}
    #shots{flex:1}
    .char-block{margin-bottom:26px}
    .char-title{font-weight:700;margin:6px 0}
    /* ✅ 획별 스냅샷을 가로(row)로 배치 */
    .thumbs{display:flex;flex-direction:row;gap:6px;flex-wrap:wrap}
    .thumbs img{width:80px;height:80px;object-fit:contain;
      border:1px solid #ddd;border-radius:4px;background:#fff}
    .muted{color:#666;font-size:12px}
  </style>
</head>
<body>
  <h1>한자 쓰기 애니메이션 & 획별 스냅샷</h1>

  <div id="controls">
    <input id="charInput" type="text" value="学,国,人" style="width:260px"
           title="쉼표로 여러 글자 입력" />
    <button id="runBtn">애니메이션 시작</button>
    <span class="muted">예: 学,国,中,人</span>
  </div>

  <div class="row">
    <!-- 애니메이션 상자 -->
    <div id="stage"></div>
    <!-- 획별 캡처 -->
    <div id="shots"></div>
  </div>

  <script>
    const stageId = 'stage';
    let writer = null;

    async function snapshotCurrentSVGAsImg(size = 80){
      const svg = document.querySelector(`#${stageId} svg`);
      if(!svg) return null;
      const serializer = new XMLSerializer();
      let svgStr = serializer.serializeToString(svg);
      if(!svgStr.startsWith('<?xml'))
        svgStr = '<?xml version="1.0" standalone="no"?>\n' + svgStr;
      const svgUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgStr);
      const imgEl = new Image(); imgEl.src = svgUrl;
      return new Promise(resolve=>{
        imgEl.onload = ()=>{
          const vb = svg.viewBox.baseVal;
          const w = vb && vb.width ? vb.width : svg.clientWidth || 240;
          const h = vb && vb.height ? vb.height : svg.clientHeight || 240;
          const scale = size / Math.max(w,h);
          const canvas = document.createElement('canvas');
          canvas.width = w*scale; canvas.height = h*scale;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(imgEl,0,0,canvas.width,canvas.height);
          const out = new Image();
          out.src = canvas.toDataURL('image/png');
          out.width = size; out.height = size;
          resolve(out);
        };
        imgEl.onerror = ()=>resolve(null);
      });
    }

    async function playOneChar(ch, shotsWrap){
      document.getElementById(stageId).innerHTML = '';
      writer = HanziWriter.create(stageId, ch, {
        width: 240, height: 240, padding: 8,
        showCharacter: false, strokeColor: '#2c3e50',
        delayBetweenStrokes: 400
      });

      const block = document.createElement('div'); block.className = 'char-block';
      const title = document.createElement('div'); title.className = 'char-title'; title.textContent = `${ch} — 획별 스냅샷`;
      const thumbs = document.createElement('div'); thumbs.className = 'thumbs';
      block.appendChild(title); block.appendChild(thumbs);
      shotsWrap.appendChild(block);

      writer.animateCharacter({
        onStrokeComplete: async () => {
          const img = await snapshotCurrentSVGAsImg(80);
          if(img) thumbs.appendChild(img);
        }
      });

      await new Promise(resolve=>writer.animateCharacter({ onComplete: resolve }));
      const finalImg = await snapshotCurrentSVGAsImg(80);
      if(finalImg) thumbs.appendChild(finalImg);
    }

    async function runSequence(chars){
      const shots = document.getElementById('shots');
      shots.innerHTML = '';
      for(const ch of chars){ await playOneChar(ch, shots); }
    }

    document.getElementById('runBtn').addEventListener('click', ()=>{
      const raw = document.getElementById('charInput').value.trim();
      if(!raw) return;
      const chars = raw.split(',').map(s=>s.trim()).filter(Boolean);
      runSequence(chars);
    });
  </script>
</body>
</html>
