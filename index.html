<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>한자 쓰기 애니메이션 & 획별 스냅샷(가로·일괄 표시)</title>
  <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@latest/dist/hanzi-writer.min.js"></script>
  <style>
    body{font-family:sans-serif; margin:28px}
    h1{margin-bottom:12px}
    .row{display:flex; gap:24px; align-items:flex-start}
    #stage{
      width:260px;height:260px;border:1px solid #bbb;border-radius:8px;
      display:flex;align-items:center;justify-content:center;overflow:hidden;background:#fff;
    }
    #controls{display:flex;gap:8px;margin:12px 0 20px}
    #shots{flex:1}
    .char-block{margin-bottom:26px}
    .char-title{font-weight:700;margin:6px 0}
    /* ✅ 가로 나열 + 넘치면 다음 줄로 감기지 않도록 가로 스크롤 */
    .thumbs{
      display:flex; flex-direction:row; gap:6px;
      overflow-x:auto; white-space:nowrap; padding-bottom:6px;
    }
    .thumbs img{
      width:88px; height:88px; object-fit:contain;
      border:1px solid #ddd; border-radius:4px; background:#fff; flex:0 0 auto;
    }
    .muted{color:#666;font-size:12px}
  </style>
</head>
<body>
  <h1>한자 쓰기 애니메이션 & 획별 스냅샷</h1>

  <div id="controls">
    <input id="charInput" type="text" value="学,国,人" style="width:260px" />
    <button id="runBtn">애니메이션 시작</button>
    <span class="muted">쉼표로 여러 글자 입력 (예: 学,国,中,人)</span>
  </div>

  <div class="row">
    <div id="stage"></div>
    <div id="shots"></div>
  </div>

  <script>
    const stageId = 'stage';
    let writer = null;

    // 현재 stage의 SVG를 PNG dataURL로 캡처 → <img> 반환
    function snapshotCurrentSVGAsImg(size = 88){
      const svg = document.querySelector(`#${stageId} svg`);
      if(!svg) return Promise.resolve(null);
      const serializer = new XMLSerializer();
      let svgStr = serializer.serializeToString(svg);
      if(!svgStr.startsWith('<?xml')) svgStr = '<?xml version="1.0" standalone="no"?>\n' + svgStr;
      const svgUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgStr);

      const imgEl = new Image(); imgEl.src = svgUrl;
      return new Promise(resolve=>{
        imgEl.onload = ()=>{
          const vb = svg.viewBox.baseVal;
          const w = vb?.width || svg.clientWidth || 260;
          const h = vb?.height || svg.clientHeight || 260;
          const scale = size / Math.max(w,h);
          const canvas = document.createElement('canvas');
          canvas.width = w*scale; canvas.height = h*scale;
          canvas.getContext('2d').drawImage(imgEl,0,0,canvas.width,canvas.height);
          const thumb = new Image();
          thumb.src = canvas.toDataURL('image/png');
          thumb.width = size; thumb.height = size;
          resolve(thumb);
        };
        imgEl.onerror = ()=>resolve(null);
      });
    }

    // 글자 하나 처리: 애니메이션 동안 캡처를 배열에 담았다가, 완료 후 한 번에 렌더링
    async function playOneChar(ch, shotsWrap){
      document.getElementById(stageId).innerHTML = '';
      writer = HanziWriter.create(stageId, ch, {
        width: 260, height: 260, padding: 10,
        showCharacter: false, strokeColor: '#2c3e50', delayBetweenStrokes: 350
      });

      // UI 컨테이너
      const block = document.createElement('div'); block.className = 'char-block';
      const title = document.createElement('div'); title.className = 'char-title';
      title.textContent = `${ch} — 획별 스냅샷`;
      const thumbs = document.createElement('div'); thumbs.className = 'thumbs';
      block.appendChild(title); block.appendChild(thumbs);
      shotsWrap.appendChild(block);

      // 임시 저장소(애니메이션 끝나면 한꺼번에 붙임)
      const buffer = [];

      writer.animateCharacter({
        onStrokeComplete: async () => {
          const img = await snapshotCurrentSVGAsImg(88);
          if(img) buffer.push(img); // ← 일단 모아두기
        }
      });

      // 완료 기다리기
      await new Promise(resolve => writer.animateCharacter({ onComplete: resolve }));

      // 완성본도 추가로 캡처해서 배열 끝에
      const finalImg = await snapshotCurrentSVGAsImg(88);
      if(finalImg) buffer.push(finalImg);

      // ✅ 여기서 한 번에 DOM에 추가 → 가로로 차례대로 표시
      buffer.forEach(img => thumbs.appendChild(img));
    }

    // 여러 글자 연속 실행
    async function runSequence(chars){
      const shots = document.getElementById('shots');
      shots.innerHTML = '';
      for(const ch of chars){ await playOneChar(ch, shots); }
    }

    // 버튼
    document.getElementById('runBtn').addEventListener('click', ()=>{
      const chars = document.getElementById('charInput').value
        .split(',').map(s=>s.trim()).filter(Boolean);
      if(chars.length) runSequence(chars);
    });
  </script>
</body>
</html>
